<!DOCTYPE html> 
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© - Ø§Ù„ÙƒØ§Ù†Ø§Ø±ÙŠ HR</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#ffffff; --fg:#1f2937; --muted:#6b7280; --b:#e5e7eb; --ok:#16a34a; --bad:#dc2626; --chip:#f3f4f6; }
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;}
    .container{max-width:1100px;margin:0 auto;padding:16px;}
    .card{border:1px solid var(--b);border-radius:16px;padding:16px;}
    .row{display:grid;grid-template-columns:1fr;gap:12px;}
    @media (min-width: 768px){ .row{grid-template-columns:1fr 1fr;} }
    h1{font-size:clamp(20px,3vw,28px);margin:0 0 12px 0;color:#b91c1c;}
    h2{font-size:18px;margin:0 0 4px 0;color:#374151;}
    .hint{font-size:12px;color:var(--muted);}
    .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .stat{border:1px solid var(--b);border-radius:16px;padding:12px;background:#f9fafb;}
    .stat .label{font-size:12px;color:var(--muted);}
    .stat .value{font-weight:700;font-size:22px;}
    .ok{color:var(--ok);} .bad{color:var(--bad);}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .btn{background:#b91c1c;color:#fff;border:none;border-radius:20px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{background:var(--chip);border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid var(--b);}
    .input{padding:10px 12px;border:1px solid var(--b);border-radius:12px;min-width:260px;}
    table{width:100%;border-collapse:collapse;}
    thead{background:#f3f4f6;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--b);text-align:right;white-space:nowrap;}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid;}
    .badge.ok{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
    .badge.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca;}
    .drop{border:2px dashed var(--b);border-radius:12px;height:120px;display:flex;gap:6px;align-items:center;justify-content:center;cursor:pointer}
    .drop:hover{background:#f9fafb}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center;}
  </style>
</head>
<body>
  <div class="container">
    <header class="actions" style="justify-content:space-between;margin-bottom:12px">
      <h1>ğŸŸ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© - Ø§Ù„ÙƒØ§Ù†Ø§Ø±ÙŠ HR</h1>
      <button id="dl" class="btn" disabled>ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ XLSX</button>
    </header>

    <div class="row" style="margin-bottom:12px">
      <div class="card">
        <h2>Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Biometric)</h2>
        <div class="hint">Excel/CSV â€” Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <label class="drop">
          <input id="bioFile" type="file" accept=".xlsx,.xls,.csv" hidden>
          <span>ğŸ“‚ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
        </label>
        <div class="hint"><span id="bioCount">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯</span></div>
      </div>
      <div class="card">
        <h2>Ø§Ù„ÙƒØ´Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ (Manual)</h2>
        <div class="hint">Excel/CSV â€” Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <label class="drop">
          <input id="manFile" type="file" accept=".xlsx,.xls,.csv" hidden>
          <span>ğŸ“‚ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
        </label>
        <div class="hint"><span id="manCount">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯</span></div>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="stats">
        <div class="stat"><div class="label ok">Ù…Ø·Ø§Ø¨Ù‚</div><div id="ok" class="value ok">0</div></div>
        <div class="stat"><div class="label bad">Ù…Ø®Ø§Ù„Ù</div><div id="bad" class="value bad">0</div></div>
        <div class="stat"><div class="label">Ù†Ø§Ù‚Øµ/ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</div><div id="empty" class="value">0</div></div>
      </div>
      <div class="actions" style="margin-top:12px">
        <input id="q" class="input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯" />
        <span class="hint">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: <b id="rowsCount">0</b></span>
        <span class="pill">Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØªÙ… Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ <b>Ø§Ù„ÙƒÙˆØ¯</b></span>
      </div>
    </div>

    <div class="card" style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Ø§Ù„ÙƒÙˆØ¯</th>
            <th>Ø§Ù„Ø§Ø³Ù… (Ù…Ù† Ø§Ù„Ø¨ØµÙ…Ø©)</th>
            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ØµÙ…Ø©</th>
            <th>Ø§Ù„Ø§Ø³Ù… (Ù…Ù† Ø§Ù„ÙŠØ¯ÙˆÙŠ)</th>
            <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠ</th>
            <th>Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      Ø§Ù„ÙƒØ§Ù†Ø§Ø±ÙŠ Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Â© 2025 â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©
    </footer>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    const normalize = s => {
      if (!s) return "";
      const t = String(s).trim().replace(/\s+/g, " ").replace(/[\u200f\u200e]/g, "").toLowerCase();
      return t.replace(/\u0649/g, "ÙŠ").replace(/\u0629/g, "Ù‡").replace(/\u06cc/g, "ÙŠ").replace(/\u06a9/g, "Ùƒ");
    };

    const normalizeStatus = s => {
      const t = normalize(s).replace(/[^\u0621-\u064Aa-z0-9\s]/gi, "").trim();
      if (["Ø­Ø¶ÙˆØ±","Ø¯ÙˆØ§Ù…","present"].some(x => t.includes(x))) return "Ø­Ø¶ÙˆØ±";
      if (["ØºÙŠØ§Ø¨","absent"].some(x => t.includes(x))) return "ØºÙŠØ§Ø¨";
      if (["Ù†ØµÙ Ø¯ÙˆØ§Ù…","Ù†ØµÙ","half","0.5"].some(x => t.includes(x))) return "Ù†ØµÙ Ø¯ÙˆØ§Ù…";
      return s || "";
    };

    const readSheet = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval: '' });

          const rows = []; 
          const lowerKeys = obj => { const out = {}; for (const k of Object.keys(obj)) out[normalize(k)] = obj[k]; return out; };
          const keyMap = { code: ["Ø§Ù„ÙƒÙˆØ¯","code","Ø±Ù‚Ù… Ø§Ù„ÙƒÙˆØ¯","id","emp code"], name: ["Ø§Ù„Ø§Ø³Ù…","name","employee","emp name"], status: ["Ø§Ù„Ø­Ø§Ù„Ù‡","Ø§Ù„Ø­Ø§Ù„Ø©","status","presence","att","attendance"] };

          for (const row of json) {
            const r = lowerKeys(row);
            const findCol = alts => {
              for (const a of alts) {
                const n = normalize(a);
                const key = Object.keys(r).find(k => k.includes(n));
                if (key) return r[key];
              } return '';
            };
            const code = String(findCol(keyMap.code)).trim();
            const name = String(findCol(keyMap.name)).trim();
            const status = String(findCol(keyMap.status)).trim();
            if (!code && !name && !status) continue;
            rows.push({ code, name, status });
          }
          resolve(rows);
        } catch (err) { reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });

    const toMap = rows => {
      const map = new Map();
      for (const r of rows || []) {
        const key = normalize(r.code);
        if (key) map.set(key, r);
      }
      return map;
    };

    let bioRows = [], manRows = [], allRows = [];

    const compare = () => {
      const bioMap = toMap(bioRows), manMap = toMap(manRows);
      const codes = new Set([...bioMap.keys(), ...manMap.keys()]);
      const res = [];
      for (const key of codes) {
        const b = bioMap.get(key), m = manMap.get(key);
        const bS = normalizeStatus(b?.status || '');
        const mS = normalizeStatus(m?.status || '');
        let match = '';
        if (b || m) match = (bS && mS) ? (bS === mS ? 'Ù…Ø·Ø§Ø¨Ù‚' : 'Ù…Ø®Ø§Ù„Ù') : '';
        res.push({
          code: b?.code || m?.code || '',
          nameBiometric: b?.name || '',
          statusBiometric: bS || b?.status || '',
          nameManual: m?.name || '',
          statusManual: mS || m?.status || '',
          match
        });
      }
      res.sort((a,b) => normalize(a.code).localeCompare(normalize(b.code), 'ar'));
      allRows = res;
      render();
    };

    const render = () => {
      const q = normalize($('#q').value || '');
      const rows = q ? allRows.filter(r =>
        normalize(r.code).includes(q) ||
        normalize(r.nameBiometric).includes(q) ||
        normalize(r.nameManual).includes(q)
      ) : allRows;

      $('#rowsCount').textContent = rows.length;
      const ok = rows.filter(r => r.match==='Ù…Ø·Ø§Ø¨Ù‚').length;
      const bad = rows.filter(r => r.match==='Ù…Ø®Ø§Ù„Ù').length;
      const empty = rows.length - ok - bad;
      $('#ok').textContent = ok; $('#bad').textContent = bad; $('#empty').textContent = empty;

      const tbody = $('#tbl tbody'); tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        const cells = [
          r.code, r.nameBiometric, r.statusBiometric, r.nameManual, r.statusManual,
          r.match ? `<span class="badge ${r.match==='Ù…Ø·Ø§Ø¨Ù‚'?'ok':'bad'}">${r.match}</span>` : '<span class="badge">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>'
        ];
        for (let i=0;i<cells.length;i++){
          const td = document.createElement('td');
          td.innerHTML = cells[i];
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      $('#dl').disabled = !rows.length;
    };

    const downloadXLSX = () => {
      const rows = allRows.map(r => ({
        'Ø§Ù„ÙƒÙˆØ¯': r.code,
        'Ø§Ù„Ø§Ø³Ù… (Ù…Ù† Ø§Ù„Ø¨ØµÙ…Ø©)': r.nameBiometric,
        'Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ØµÙ…Ø©': r.statusBiometric,
        'Ø§Ù„Ø§Ø³Ù… (Ù…Ù† Ø§Ù„ÙŠØ¯ÙˆÙŠ)': r.nameManual,
        'Ø­Ø§Ù„Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠ': r.statusManual,
        'Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©': r.match
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ù…Ù‚Ø§Ø±Ù†Ø©');
      XLSX.writeFile(wb, 'kanari_attendance_' + new Date().toISOString().slice(0,10) + '.xlsx');
    };

    const hookDrop = (label, input, onPick) => {
      label.addEventListener('click', () => input.click());
      ['dragover','dragenter'].forEach(ev => label.addEventListener(ev, e=>{e.preventDefault(); label.style.background='#f3f4f6';}));
      ['dragleave','drop'].forEach(ev => label.addEventListener(ev, e=>{e.preventDefault(); label.style.background='';}));
      label.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; if (f) onPick(f); });
      input.addEventListener('change', e => { const f = input.files?.[0]; if (f) onPick(f); });
    };

    hookDrop(document.querySelectorAll('.drop')[0], $('#bioFile'), async (f) => {
      bioRows = await readSheet(f);
      $('#bioCount').textContent = (bioRows.length? (bioRows.length + ' ØµÙ') : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯');
      compare();
    });
    hookDrop(document.querySelectorAll('.drop')[1], $('#manFile'), async (f) => {
      manRows = await readSheet(f);
      $('#manCount').textContent = (manRows.length? (manRows.length + ' ØµÙ') : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯');
      compare();
    });

    $('#q').addEventListener('input', render);
    $('#dl').addEventListener('click', downloadXLSX);
  </script>
</body>
</html>
